---
title: "HR Efficiency Analysis"
output: 
  html_document:
    fig_width: 14
    fig_height: 8
    out_width: '900px'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
library(dplyr)
library(ggplot2)
```

## Problem
###Factors important to retain performing employees

## Data
https://www.kaggle.com/ludobenistant/hr-analytics

https://www.kaggle.com/ludobenistant/hr-analytics/downloads/human-resources-analytics.zip

```{r Loading Data }
#About Data
  hr <- read.csv("./HR_comma_sep.csv", header = TRUE)

#Lets analyze the structure
  str(hr)

  summary(hr)

```
####Observations

* There are no NA or blanks values. 
* Columns number_project, promotion_last_5years, left, Work_accident maybe factors.
* Also sales columns does not seems to have sales figures but departments that employee belongs to.

```{r Cleansing Data}

#Lets make columns number_project, promotion_last_5years, left, Work_accident as factors
  hr$number_project <-
    as.factor(hr$number_project)
    hr$promotion_last_5years <-
    as.factor(hr$promotion_last_5years)
    hr$left <- as.factor(hr$left)
    hr$Work_accident <-
    as.factor(hr$Work_accident)
  
#Add a new column for total employee count
  hr$total_emp <- NROW(hr)
  
# Rename the sales column to dept
  names(hr)[9] <- "dept"
  
#lets look are structure once again
  str(hr)
```
## Data Exploration

####Analyze time_spend_company 
Lets check histogram of time_spend_company facetted by various departments

```{r}
plot_tm_spend <- hr %>% 
  ggplot(aes(time_spend_company, fill = left)) + 
  geom_histogram() + 
  facet_grid(. ~ dept) +
  labs(x = "Time spend in company (in years)", y = "employees")
plot_tm_spend
```

####Observation
* Looks like on average employees stay 5 - 7.5 years in the company.
* Employees who have spent more than 7.5 years tends to have lower attrition.

####Analyze number_project
Lets check histogram of number_project facetted by various departments
```{r}
plot_num_prj <- hr %>% 
  ggplot(aes(as.numeric(number_project), fill = left)) + 
  geom_histogram() + 
  facet_grid(. ~ dept) +
  labs(x = "Number of projects in a year", y = "employees")
plot_num_prj
```

####Observation
Across departments 2-4 projects seems to provide better percent of employee retention

####Analyze last_evaluation
Lets check histogram of last_evaluation facetted by various departments
```{r}
plot_lst_eval <- hr %>% 
  ggplot(aes(as.numeric(last_evaluation), fill = left)) + 
  geom_histogram() + 
  facet_grid(. ~ dept) +
  labs(x = "Latest evaluation rating", y = "employees")
plot_lst_eval
```

####Observation
* Looks like employees having evaluation rating of 0.7 have higher odds of staying.
* Also company's success rate in retaining performaing employees beyond 0.7 is low.
* There is room for improvement to retain high performers

####Analyze average_monthly_hours
Lets check histogram of average_monthly_hours facetted by various departments
```{r}
plot_avg_montly_hrs <- hr %>% 
  ggplot(aes(average_montly_hours, fill = left)) + 
  geom_histogram() + 
  facet_grid(. ~ dept) +
  labs(x = "Average monthly untilization (in hours)", y = "employees")
plot_avg_montly_hrs
```

####Observation
* Company faring well in retaining employees having average monthly utilization of around 200 hours
* Company performs poorly in retaining employees who put higher of 200 hours.
* Employees who put in less than 200 hours though have high attrition, maybe its ok since they aren't contributing enough or poor performers

##Regression Model

###Train Data
```{r}
library(caret)
set.seed(3456)
trainIndex <- createDataPartition(hr$time_spend_company, p = .8, 
                                  list = FALSE, 
                                  times = 1)
head(trainIndex)

hrTrain <- hr[ trainIndex,]

```
###Test Data
```{r}
hrTest  <- hr[-trainIndex,]
```
###Linear Regression Model

```{r}
lm_emp_leaving1 <- lm(time_spend_company~left+number_project+last_evaluation+average_montly_hours, data = hrTrain)
lm_emp_leaving <- lm(time_spend_company~number_project+last_evaluation+average_montly_hours, data = hrTrain)
```

###Summary of the Model
```{r}

summary(lm_emp_leaving1)
summary(lm_emp_leaving)
```

###Annova for the model
```{r}
anova(lm_emp_leaving1,lm_emp_leaving)
```

###Predict for the model lm_emp_leaving
```{r}
predict_lm_emp_leaving <- predict(lm_emp_leaving, newdata = hrTest)
summary(predict_lm_emp_leaving)

#Lets predict how long a employee with stay
predDat <- with(
  hr,
  expand.grid(
    number_project = as.factor(c("2", 
                                 ceiling(
                                   mean(as.numeric(number_project))),
                                 "4","6")),
    last_evaluation = c(0.1, 0.5, 0.7, 0.8, 0.9, 1.0),
    average_montly_hours = c(100, 
                             round(
                               mean(average_montly_hours)), 
                             400)
              )
  )
  prediction <- cbind(
    predDat,
    predict(
      lm_emp_leaving,
      newdata = predDat
            )
  )
   
  names(prediction)[4] <- "est_time_spent"
  
  prediction %>% ggplot(aes(est_time_spent, fill = number_project)) + geom_histogram()
  
  prediction %>% ggplot(aes(est_time_spent, fill = as.factor(last_evaluation))) + geom_histogram()
  
  prediction %>% ggplot(aes(est_time_spent, fill = as.factor(average_montly_hours))) + geom_histogram()

```
