---
title: "HR Efficiency Analysis"
date: "`r format(Sys.Date())`"
output: 
  html_document:
    keep_md: true
    fig_width: 14
    fig_height: 8
    out_width: '900px'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
library(caret)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(RColorBrewer)
myTheme <- theme( panel.background=element_blank(),panel.grid = element_blank(), legend.key = element_blank(), plot.title = element_text(hjust = 0.5))
```

## Problem
###Factors important to retain performing employees
Why are our best and most experienced employees leaving prematurely? Can we predict which valuable employees will leave next?

## Data Source
https://www.kaggle.com/ludobenistant/hr-analytics

https://www.kaggle.com/ludobenistant/hr-analytics/downloads/human-resources-analytics.zip

Lets load the dataset
```{r Loading Data }
  hr <- read.csv("./HR_comma_sep.csv", header = TRUE, stringsAsFactors = FALSE)
```

####$Lets look at the fields in the dataset

* _satisfaction_level_ - Level of satisfaction (0-1)
* _last_evaluation_ - Evaluation of employee performance (0-1)
* _number_project_ - Number of projects completed while at work
* _average_montly_hours_ - Average monthly hours at workplace
* _time_spend_company_ - Number of years spent in the company
* _Work_accident_ - Whether the employee had a workplace accident
* _left_ - Whether the employee left the workplace or not (1 or 0) 
* _promotion_last_5years_ - Whether the employee was promoted in the last five years
* _sales_ - Department in which they work for
* _salary_ - Salary (High, medium, Low)

Lets analyze the structure of dataset
```{r}
  str(hr)
```
####Observations
* Fields _number_project_, _promotion_last_5years_, _left_, _Work_accident_ maybe factors.
* Also field _sales_ does not seems to have sales figures but departments that employee belongs to.

Lets look at the summary of the data set
```{r }
  summary(hr)
```
####Observations
* All fields in the dataset have non-NA values. 
* _sales_ seems to have _(other)_

Lets look at all unique values for field 'sales'. Looks like 'sales' have values.
```{r}
unique(hr$sales)
```
## Data Wrangling


Rename the _sales_ field to _dept_
```{r}
  names(hr)[9] <- "dept"
```

Lets look are structure once again
```{r}
  str(hr)
```

## Data Exploration

Lets analyze _satisfaction_level_, _time_spend_company_, _last_evaluation_, _average_monthly_hours_, _work_accident_, _salary_ and _number_project_


```{r plot_data_exp_analysis}
hr_left <- hr %>% filter(left == 1)

satis_l <- hr_left %>% ggplot(aes(satisfaction_level)) +
  geom_histogram( binwidth = 0.05) + 
  labs(x = "satisfaction_level", y = "employees", title = "satisfaction level") + myTheme

tm_spnd <- hr_left %>% ggplot(aes(time_spend_company)) +
  geom_histogram( binwidth = 0.05) + 
  labs(x = "time_spend_company", y = "employees", title = "Time Spend in Company") + myTheme

lst_eval <- hr_left %>% ggplot(aes(last_evaluation)) +
  geom_histogram( binwidth = 0.05) + 
  labs(x = "last_evaluation", y = "employees", title = "Last evaluation") + myTheme

mnthly_hrs <- hr_left %>% ggplot(aes(average_montly_hours)) +
  geom_histogram( binwidth = 0.05) + 
  labs(x = "average_montly_hours", y = "employees", title = "Average montly hours") + myTheme

wrk_accdnt <- hr_left %>% ggplot(aes(Work_accident)) +
  geom_histogram( binwidth = 0.05) + 
  labs(x = "Work_accident", y = "employees", title = "Work accident") + myTheme

sal <- hr_left %>% ggplot(aes(as.numeric(salary))) +
  geom_histogram( binwidth = 0.05) + 
  labs(x = "salary", y = "employees", title = "Salary") + myTheme

nmbr_prj <- hr_left %>% ggplot(aes(number_project)) +
  geom_histogram( binwidth = 0.05) + 
  labs(x = "number_project", y = "employees", title = "Number of projects") + myTheme

grid.arrange(satis_l, tm_spnd, lst_eval,mnthly_hrs,wrk_accdnt,sal,nmbr_prj, nrow = 4)
```



##Regression Model

###Linear Regression
Lets build a model to determine how long an employee will stay

####Train Data
```{r}

set.seed(3456)
trainIndex <- createDataPartition(hr$time_spend_company, p = .8, 
                                  list = FALSE, 
                                  times = 1)
head(trainIndex)

hrTrain <- hr[ trainIndex,]

```
###Test Data
```{r}
hrTest  <- hr[-trainIndex,]
```

###Models

```{r}
lm_time_spend <- lm(time_spend_company~left+number_project+last_evaluation+salary+Work_accident+satisfaction_level, data = hrTrain)
summary(lm_time_spend)
```

```{r}
lm_time_spend_mthly_hrs <- lm(time_spend_company~left+number_project+last_evaluation+average_montly_hours+salary+Work_accident+satisfaction_level, data = hrTrain)
summary(lm_time_spend_mthly_hrs)
```

###Anova for the model
```{r}
anova(lm_time_spend,lm_time_spend_mthly_hrs)
```

###Predict using the model _lm_time_spend_mthly_hrs_
```{r}
predict_lm_emp_leaving <- predict(lm_time_spend_mthly_hrs, newdata = hrTest)
#summary of prediction
summary(predict_lm_emp_leaving)

#summary of actuals
summary(hrTest$time_spend_company)

#plot actual vs predicted
p <- data.frame(predict_lm_emp_leaving)
p$ID <- as.numeric(rownames(p))
p$Type <- 'Predicted'
names(p)[1] <- 'time_spend_company'

a <- data.frame(hrTest$time_spend_company)
a$ID <- as.numeric(rownames(hrTest))
a$Type <- 'Actual'
names(a)[1] <- 'time_spend_company'

m <- data.frame(rbind(a,p))

m %>% ggplot(aes(x = ID, y = time_spend_company, col = Type)) + 
  geom_line() + 
  geom_smooth() +
  labs(x = "Observation", y = "Number of years spent in the company", title = "Plot Predicted & Actual Time spend vs Observation") +
  scale_colour_brewer(palette = brewer.pal(11,"Spectral")) +
  myTheme

#correlation data
plot_data <- data.frame(predict_lm_emp_leaving, hrTest$time_spend_company)
names(plot_data)[1] <- "predicted"
names(plot_data)[2] <- "actual"

correlation <- cor(plot_data)
correlation

#coreelation
correlation[1,2]

#lets see how good the model prediction was

#Sum of squared errors(SSE)
sse = sum((hrTest$time_spend_company - predict_lm_emp_leaving ) ^ 2)
round(sse, digits = 2)

#Root mean squared errors (RMSE)
rmse = sqrt(sse / nrow(hrTest))
round(rmse, digits = 4)

```

###Logistic Regression
Lets build a model to predict if the employee will leave

####Train Data
```{r}

set.seed(3456)
trainIndex <- createDataPartition(hr$left, p = .8, 
                                  list = FALSE, 
                                  times = 1)
head(trainIndex)

hrTrain <- hr[ trainIndex,]

```
###Test Data
```{r}
hrTest  <- hr[-trainIndex,]
```

###Models

```{r log_model}
mod1 <- glm(left ~ time_spend_company + last_evaluation + salary + satisfaction_level, data = hrTrain , family = "binomial")
summary(mod1)
```

```{r}
#Lets test prediction using test data 
testPredication <- predict(mod1, newdata = hrTest, type = "response")
table(hrTest$left, testPredication >= 0.18)

```


