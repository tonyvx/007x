---
title: "HR Efficiency Analysis"
output: 
  html_document:
    fig_width: 14
    fig_height: 8
    out_width: '900px'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
library(caret)
library(dplyr)
library(ggplot2)
library(GGally)
```

## Problem
###Factors important to retain performing employees
Why are our best and most experienced employees leaving prematurely? Can we predict which valuable employees will leave next?

## Data Source
https://www.kaggle.com/ludobenistant/hr-analytics

https://www.kaggle.com/ludobenistant/hr-analytics/downloads/human-resources-analytics.zip

Lets load the dataset
```{r Loading Data }
  hr <- read.csv("./HR_comma_sep.csv", header = TRUE)
```

Lets look at the fields in the dataset
```{r fields }
  names(hr)
```

Lets analyze the structure of dataset
```{r}
  str(hr)
```
####Observations
* Fields 'number_project', 'promotion_last_5years', 'left', 'Work_accident' maybe factors.
* Also field 'sales' does not seems to have sales figures but departments that employee belongs to.

Lets look at the summary of the data set
```{r }
  summary(hr)
```
####Observations
* All fields in the dataset have non-NA values. 
* sales seems to have '(other)'

Lets look at all unique values for field 'sales'. Looks like 'sales' have values.
```{r}
unique(hr$sales)
```
## Data Wrangling

Lets make fields 'number_project', 'promotion_last_5years', 'left', 'Work_accident' as factors
```{r Cleansing Data}
  hr$number_project <-
    as.factor(hr$number_project)
    hr$promotion_last_5years <-
    as.factor(hr$promotion_last_5years)
    hr$left <- as.factor(hr$left)
    hr$Work_accident <-
    as.factor(hr$Work_accident)
```

Rename the 'sales' field to dept
```{r}
  names(hr)[9] <- "dept"
```

Lets look are structure once again
```{r}
  str(hr)
```

## Data Exploration

Lets analyze 'satisfaction_level', 'time_spend_company', 'last_evaluation', 'average_monthly_hours', 'work_accident' 'salary','number_project'


```{r}
hr_left <- hr %>% filter(left == 1)
par(mfrow = c(1, 3))
hist(hr_left$satisfaction_level, col = "#3090C7", main = "Satisfaction level")

hist(hr_left$last_evaluation, col = "#3090C7", main = "Last evaluation")

hist(hr_left$average_montly_hours,
col = "#3090C7",
main = "Average montly hours")
hist(as.numeric(hr_left$Work_accident),
col = "#3090C7",
main = "Work accident")
plot(hr_left$salary, col = "#3090C7", main = "Salary")
hist(as.numeric(hr_left$number_project),
col = "#3090C7",
main = "Number of projects")
```


##Regression Model

###Linear Regression
Lets build a model to determine how long an employee will stay

####Train Data
```{r}

set.seed(3456)
trainIndex <- createDataPartition(hr$time_spend_company, p = .8, 
                                  list = FALSE, 
                                  times = 1)
head(trainIndex)

hrTrain <- hr[ trainIndex,]

```
###Test Data
```{r}
hrTest  <- hr[-trainIndex,]
```


```{r}
lm_time_spend_mthly_hrs<- lm(time_spend_company~left+number_project+last_evaluation+average_montly_hours+salary+Work_accident+satisfaction_level, data = hrTrain)
lm_time_spend <- lm(time_spend_company~left+number_project+last_evaluation+salary+Work_accident+satisfaction_level, data = hrTrain)
```

###Summary of the Model
```{r}

summary(lm_time_spend_mthly_hrs)
summary(lm_time_spend)
```

###Annova for the model
```{r}
anova(lm_time_spend_mthly_hrs,lm_time_spend)
```

###Predict for the model lm_emp_leaving
```{r}
predict_lm_emp_leaving <- predict(lm_time_spend_mthly_hrs, newdata = hrTest)
plot(predict_lm_emp_leaving)

summary(predict_lm_emp_leaving)
#Lets predict how long a employee with stay
predDat <- with(
  hr,
  expand.grid(
    number_project = as.factor(c("2", 
                                 ceiling(
                                   mean(as.numeric(number_project))),
                                 "4","6")),
    last_evaluation = c(0.1, 0.5, 0.7, 0.8, 0.9, 1.0),
    average_montly_hours = c(100, 
                             round(
                               mean(average_montly_hours)), 
                             400)
              )
  )
  prediction <- cbind(
    predDat,
    predict(
      lm_emp_leaving,
      newdata = predDat
            )
  )
   
  names(prediction)[4] <- "est_time_spent"
  
  prediction %>% ggplot(aes(est_time_spent, fill = number_project)) + geom_histogram()
  
  prediction %>% ggplot(aes(est_time_spent, fill = as.factor(last_evaluation))) + geom_histogram()
  
  prediction %>% ggplot(aes(est_time_spent, fill = as.factor(average_montly_hours))) + geom_histogram()

```
