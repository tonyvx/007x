---
title: "HR Efficiency Analysis"
date: "`r format(Sys.Date())`"
output: 
  html_document:
    keep_md: true
    fig_width: 14
    fig_height: 8
    out_width: '900px'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
library(caret)
library(dplyr)
library(ggplot2)
library(gridExtra)
```

## Problem
###Factors important to retain performing employees
Why are our best and most experienced employees leaving prematurely? Can we predict which valuable employees will leave next?

## Data Source
https://www.kaggle.com/ludobenistant/hr-analytics

https://www.kaggle.com/ludobenistant/hr-analytics/downloads/human-resources-analytics.zip

Lets load the dataset
```{r Loading Data }
  hr <- read.csv("./HR_comma_sep.csv", header = TRUE)
```

Lets look at the fields in the dataset
```{r fields }
  names(hr)
```

Lets analyze the structure of dataset
```{r}
  str(hr)
```
####Observations
* Fields _number_project_, _promotion_last_5years_, _left_, _Work_accident_ maybe factors.
* Also field _sales_ does not seems to have sales figures but departments that employee belongs to.

Lets look at the summary of the data set
```{r }
  summary(hr)
```
####Observations
* All fields in the dataset have non-NA values. 
* _sales_ seems to have _(other)_

Lets look at all unique values for field 'sales'. Looks like 'sales' have values.
```{r}
unique(hr$sales)
```
## Data Wrangling

Lets make fields _number_project_, _promotion_last_5years_, _left_, _Work_accident_ as factors
```{r Cleansing Data}
  hr$number_project <-
    as.factor(hr$number_project)
    hr$promotion_last_5years <-
    as.factor(hr$promotion_last_5years)
    hr$left <- as.factor(hr$left)
    hr$Work_accident <-
    as.factor(hr$Work_accident)
```

Rename the _sales_ field to _dept_
```{r}
  names(hr)[9] <- "dept"
```

Lets look are structure once again
```{r}
  str(hr)
```

## Data Exploration

Lets analyze _satisfaction_level_, _time_spend_company_, _last_evaluation_, _average_monthly_hours_, _work_accident_, _salary_ and _number_project_


```{r plot_data_exp_analysis}
hr_left <- hr %>% filter(left == 1)

satis_l <- hr_left %>% ggplot(aes(satisfaction_level)) +
  geom_histogram( binwidth = 0.05) + 
  labs(x = "satisfaction_level", y = "employees", title = "satisfaction level")

tm_spnd <- hr_left %>% ggplot(aes(time_spend_company)) +
  geom_histogram( binwidth = 0.05) + 
  labs(x = "time_spend_company", y = "employees", title = "Time Spend in Company")

lst_eval <- hr_left %>% ggplot(aes(last_evaluation)) +
  geom_histogram( binwidth = 0.05) + 
  labs(x = "last_evaluation", y = "employees", title = "Last evaluation")

mnthly_hrs <- hr_left %>% ggplot(aes(average_montly_hours)) +
  geom_histogram( binwidth = 0.05) + 
  labs(x = "average_montly_hours", y = "employees", title = "Average montly hours")

wrk_accdnt <- hr_left %>% ggplot(aes(as.numeric(Work_accident))) +
  geom_histogram( binwidth = 0.05) + 
  labs(x = "Work_accident", y = "employees", title = "Work accident")

sal <- hr_left %>% ggplot(aes(as.numeric(salary))) +
  geom_histogram( binwidth = 0.05) + 
  labs(x = "salary", y = "employees", title = "Salary")

nmbr_prj <- hr_left %>% ggplot(aes(as.numeric(number_project))) +
  geom_histogram( binwidth = 0.05) + 
  labs(x = "number_project", y = "employees", title = "Number of projects")

grid.arrange(satis_l, tm_spnd, lst_eval,mnthly_hrs,wrk_accdnt,sal,nmbr_prj, ncol=3)
```


##Regression Model

###Linear Regression
Lets build a model to determine how long an employee will stay

####Train Data
```{r}

set.seed(3456)
trainIndex <- createDataPartition(hr$time_spend_company, p = .8, 
                                  list = FALSE, 
                                  times = 1)
head(trainIndex)

hrTrain <- hr[ trainIndex,]

```
###Test Data
```{r}
hrTest  <- hr[-trainIndex,]
```

###Models

```{r}
lm_time_spend_mthly_hrs <- lm(time_spend_company~left+number_project+last_evaluation+average_montly_hours+salary+Work_accident+satisfaction_level, data = hrTrain)
```

```{r}
lm_time_spend <- lm(time_spend_company~left+number_project+last_evaluation+salary+Work_accident+satisfaction_level, data = hrTrain)
```

###Anova for the model
```{r}
anova(lm_time_spend_mthly_hrs,lm_time_spend)
```

###Predict using the model _lm_time_spend_mthly_hrs_
```{r}
predict_lm_emp_leaving <- predict(lm_time_spend_mthly_hrs, newdata = hrTest)
#summary of prediction
summary(predict_lm_emp_leaving)

#summary of actuals
summary(hrTest$time_spend_company)

#plot actual vs predicted
plot_data <- data.frame(floor(predict_lm_emp_leaving), hrTest$time_spend_company)
names(plot_data)[1] <- "predicted"
names(plot_data)[2] <- "actual"

#correlation data
correlation <- cor(plot_data)
correlation

#coreelation
correlation[1,2]

#lets see how good the model prediction was

#Sum of squared errors(SSE)
sse = sum((hrTest$time_spend_company - predict_lm_emp_leaving ) ^ 2)
round(sse, digits = 2)

#Root mean squared errors (RMSE)
rmse = sqrt(sse / nrow(hrTest))
round(rmse, digits = 4)

```

###Logistic Regression
Lets build a model to predict if the employee will leave

####Train Data
```{r}

set.seed(3456)
trainIndex <- createDataPartition(hr$left, p = .8, 
                                  list = FALSE, 
                                  times = 1)
head(trainIndex)

hrTrain <- hr[ trainIndex,]

```
###Test Data
```{r}
hrTest  <- hr[-trainIndex,]
```

###Models

```{r log_model}
mod1 <- glm(left ~ time_spend_company + last_evaluation + salary + satisfaction_level, data = hrTrain , family = "binomial")
summary(mod1)
```

```{r}
#Lets test prediction using test data 
testPredication <- predict(mod1, newdata = hrTest, type = "response")
table(hrTest$left, testPredication >= 0.18)

```



